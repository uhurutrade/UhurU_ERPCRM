generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Auth
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          String    @default("USER") // ADMIN for the owner
  accounts      Account[]
  sessions      Session[]
  tasks         Task[]    @relation("AssignedTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                  String  @id @default(cuid())
  userId              String
  type                String
  provider            String
  providerAccountId   String
  refresh_token       String? @db.Text
  access_token        String? @db.Text
  expires_at          Int?
  token_type          String?
  scope               String?
  id_token            String? @db.Text
  session_state       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// CRM
model Organization {
  id          String    @id @default(cuid())
  name        String
  sector      String?
  website     String?
  address     String?
  contacts    Contact[]
  deals       Deal[]
  
  // CORRECCIÓN: Se añade la relación inversa para Invoice (factura)
  invoices    Invoice[] // <--- LÍNEA AÑADIDA

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id             String        @id @default(cuid())
  name           String
  email          String?
  phone          String?
  role           String?
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  activities     Activity[]

  isClient       Boolean       @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lead {
  id          String   @id @default(cuid())
  name        String
  email       String?
  source      String?  // LinkedIn, X, etc
  status      String   @default("NEW") // NEW, CONTACTED, QUALIFIED, LOST
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Deal {
  id             String         @id @default(cuid())
  title          String
  amount         Decimal?       @db.Decimal(10, 2)
  currency       String         @default("GBP")
  stage          String         // PROSPECTING, PROPOSAL, NEGOTIATION, WON, LOST
  closeDate      DateTime?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id            String    @id @default(cuid())
  title         String
  description   String?
  dueDate       DateTime?
  completed     Boolean   @default(false)

  assignedToId  String?
  assignedTo    User?     @relation("AssignedTo", fields: [assignedToId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Activity {
  id        String   @id @default(cuid())
  type      String   // CALL, EMAIL, MEETING
  notes     String?  @db.Text
  date      DateTime @default(now())

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])
}

// ERP & Banking
// Bank Settings - Traditional Banks
model Bank {
  id                  String         @id @default(cuid())
  
  // Basic Bank Information
  bankName            String         // Revolut, Wise, Worldfirst, HSBC, etc.
  bankType            String         // TRADITIONAL, NEOBANK, PAYMENT_PROVIDER
  
  // Bank Details
  swiftBic            String?        // SWIFT/BIC code
  bankCode            String?        // Bank code (varies by country)
  
  // Contact Information
  website             String?
  supportEmail        String?
  supportPhone        String?
  
  // Address
  bankAddress         String?
  bankCity            String?
  bankPostcode        String?
  bankCountry         String?
  
  // Status
  isActive            Boolean        @default(true)
  
  // Notes
  notes               String?        @db.Text
  
  // Relations
  accounts            BankAccount[]
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

// Bank Accounts - Specific accounts per currency
model BankAccount {
  id                  String            @id @default(cuid())
  
  // Bank Reference
  bankId              String
  bank                Bank              @relation(fields: [bankId], references: [id], onDelete: Cascade)
  
  // Account Information
  accountName         String            // e.g., "Main EUR Account", "USD Business Account"
  accountType         String            // CHECKING, SAVINGS, BUSINESS, MULTI_CURRENCY
  currency            String            // EUR, USD, GBP, CHF
  
  // Account Numbers (varies by currency/country)
  // EUR (SEPA)
  iban                String?           // International Bank Account Number
  
  // USD (USA)
  accountNumber       String?           // Account number
  routingNumber       String?           // ABA routing number (USA) - mostly for ACH
  wireRoutingNumber   String?           // Wire transfer routing number (if different)
  
  // GBP (UK)
  sortCode            String?           // UK sort code (6 digits)
  accountNumberUK     String?           // UK account number (8 digits)
  
  // CHF (Switzerland)
  ibanCH              String?           // Swiss IBAN
  bcNumber            String?           // BC number (Switzerland)
  
  // Additional identifiers
  swiftBic            String?           // SWIFT/BIC for this specific account
  
  // Balance tracking (optional)
  currentBalance      Decimal?          @db.Decimal(15, 2)
  availableBalance    Decimal?          @db.Decimal(15, 2)
  lastBalanceUpdate   DateTime?
  
  // Status
  isActive            Boolean           @default(true)
  isPrimary           Boolean           @default(false) // Primary account for this currency
  order               Int               @default(0)     // Order for display
  
  // Notes
  notes               String?           @db.Text
  
  // Relations
  transactions        BankTransaction[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  
  @@index([bankId])
  @@index([currency])
}

// Crypto Wallets - Corporate crypto wallets
model CryptoWallet {
  id                  String         @id @default(cuid())
  
  // Wallet Information
  walletName          String         // e.g., "Corporate USDC Wallet", "BTC Treasury"
  walletType          String         // HOT_WALLET, COLD_WALLET, HARDWARE, EXCHANGE
  
  // Blockchain & Network
  blockchain          String         // BITCOIN, ETHEREUM, POLYGON, BINANCE_SMART_CHAIN, etc.
  network             String         // MAINNET, TESTNET
  
  // Token/Asset
  asset               String         // BTC, ETH, USDC, USDT, etc.
  assetType           String         // NATIVE, ERC20, BEP20, etc.
  contractAddress     String?        // For tokens (e.g., USDC contract address)
  
  // Wallet Address
  walletAddress       String         @unique // Public address for receiving funds
  
  // Additional Information
  provider            String?        // MetaMask, Ledger, Coinbase, Binance, etc.
  
  // Balance tracking (optional)
  currentBalance      Decimal?       @db.Decimal(25, 8) // Higher precision for crypto
  balanceUSD          Decimal?       @db.Decimal(15, 2) // USD equivalent
  lastBalanceUpdate   DateTime?
  
  // Security
  isMultiSig          Boolean        @default(false)
  requiredSignatures  Int?           // For multi-sig wallets
  
  // Status
  isActive            Boolean        @default(true)
  
  // Notes
  notes               String?        @db.Text
  
  // Relations
  transactions        CryptoTransaction[]
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  @@index([blockchain])
  @@index([asset])
}

// Crypto Transactions
model CryptoTransaction {
  id                  String         @id @default(cuid())
  
  // Wallet Reference
  walletId            String
  wallet              CryptoWallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Transaction Details
  txHash              String         @unique // Transaction hash on blockchain
  type                String         // DEPOSIT, WITHDRAWAL, INTERNAL_TRANSFER
  
  // Amounts
  amount              Decimal        @db.Decimal(25, 8)
  asset               String         // BTC, ETH, USDC, etc.
  
  // USD Value (at time of transaction)
  amountUSD           Decimal?       @db.Decimal(15, 2)
  exchangeRate        Decimal?       @db.Decimal(15, 8)
  
  // Addresses
  fromAddress         String?
  toAddress           String?
  
  // Fees
  networkFee          Decimal?       @db.Decimal(25, 8)
  networkFeeUSD       Decimal?       @db.Decimal(15, 2)
  
  // Status
  status              String         // PENDING, CONFIRMED, FAILED
  confirmations       Int?
  
  // Blockchain info
  blockNumber         String?
  timestamp           DateTime
  
  // Categorization
  category            String?        // PAYMENT, INVESTMENT, EXCHANGE, etc.
  description         String?
  reference           String?
  
  // Metadata
  metadata            String?        @db.Text // JSON for additional data
  
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  
  @@index([walletId])
  @@index([timestamp])
}

model BankTransaction {
  id              String          @id @default(cuid())
  externalId      String?         // ID from CSV
  date            DateTime
  description     String
  amount          Decimal         @db.Decimal(15, 2)
  currency        String
  fee             Decimal?        @db.Decimal(10, 2)
  status          String?         // PENDING, COMPLETED

  // Categorization
  category        String?
  reference       String? // Payment Reference

  // Extended Banking Data
  counterparty    String?         // Payer Name / Payee Name / Beneficiary
  merchant        String?         // Merchant Name (for card spend)
  balanceAfter    Decimal?        @db.Decimal(15, 2) // Running Balance provided by bank
  exchangeRate    Decimal?        @db.Decimal(15, 8) // FX Rate used
  type            String?         // TRANSFER, CARD_PAYMENT, EXCHANGE, FEE, etc.

  // Deduplication hash
  hash            String          @unique

  bankAccountId   String
  bankAccount     BankAccount     @relation(fields: [bankAccountId], references: [id])

  bankStatementId String?
  bankStatement   BankStatement?  @relation(fields: [bankStatementId], references: [id])

  attachments     Attachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BankStatement {
  id           String            @id @default(cuid())
  filename     String
  uploadedAt   DateTime          @default(now())

  transactions BankTransaction[]
}

model Attachment {
  id            String          @id @default(cuid())
  path          String
  fileType      String?
  originalName  String?

  transactionId String?
  transaction   BankTransaction? @relation(fields: [transactionId], references: [id])

  uploadedAt    DateTime @default(now())
}

model Asset {
  id           String    @id @default(cuid())
  name         String
  purchaseDate DateTime
  cost         Decimal
  currency     String
  type         String    // HARDWARE, SOFTWARE, ETC

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Compliance
model FiscalYear {
  id          String          @id @default(cuid())
  year        Int             @unique
  startDate   DateTime
  endDate     DateTime
  isClosed    Boolean         @default(false)

  obligations TaxObligation[]
}


model TaxObligation {
  id              String    @id @default(cuid())
  type            String    // VAT, CORPORATION_TAX, CONFIRMATION_STATEMENT, ACCOUNTS
  status          String    @default("PENDING") // PENDING, SUBMITTED, PAID, OVERDUE

  periodStart     DateTime?
  periodEnd       DateTime?
  dueDate         DateTime

  amountEstimated Decimal?  @db.Decimal(15, 2)
  amountActual    Decimal?  @db.Decimal(15, 2)

  fiscalYearId    String?
  fiscalYear      FiscalYear? @relation(fields: [fiscalYearId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ComplianceEvent {
  id            String    @id @default(cuid())
  title         String
  description   String?
  date          DateTime
  type          String    // DEADLINE, SUBMISSION, REMINDER
  isCompleted   Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Invoicing
model Invoice {
  id             String        @id @default(cuid())
  number         String        @unique // e.g. INV-001
  date           DateTime      @default(now())
  dueDate        DateTime
  status         String        @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED

  subtotal       Decimal       @db.Decimal(15, 2)
  taxRate        Decimal       @default(0) @db.Decimal(5, 2)
  taxAmount      Decimal       @db.Decimal(15, 2)
  total          Decimal       @db.Decimal(15, 2)
  currency       String        @default("GBP")

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id]) 

  items          InvoiceItem[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model InvoiceItem {
  id          String   @id @default(cuid())
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2)
  total       Decimal  @db.Decimal(15, 2)

  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// Company Settings - UK Legal Compliance
model CompanySettings {
  id                        String    @id @default(cuid())
  
  // Basic Company Information
  companyName               String
  companyNumber             String    @unique // Companies House registration number
  incorporationDate         DateTime  // Date of incorporation
  
  // Registered Office Address
  registeredAddress         String
  registeredCity            String
  registeredPostcode        String
  registeredCountry         String    @default("United Kingdom")
  
  // Trading Address (if different)
  tradingAddress            String?
  tradingCity               String?
  tradingPostcode           String?
  
  // Company Type & SIC Codes
  companyType               String    // Ltd, PLC, LLP, etc.
  sicCodes                  String?   // Standard Industrial Classification codes (comma separated)
  
  // Financial Year
  financialYearEnd          String    // Format: "DD-MM" e.g., "31-03"
  accountsNextDueDate       DateTime? // Next accounts filing deadline
  confirmationNextDueDate   DateTime? // Next confirmation statement deadline
  
  // Tax Information
  vatRegistered             Boolean   @default(false)
  vatNumber                 String?
  vatRegistrationDate       DateTime?
  vatScheme                 String?   // Standard, Flat Rate, Cash Accounting, etc.
  vatReturnFrequency        String?   // Quarterly, Monthly, Annual
  
  // HMRC Information
  payeReference             String?   // If employer
  corporationTaxReference   String?
  utr                       String?   // Unique Taxpayer Reference
  
  // Directors & Officers
  directors                 String?   @db.Text // JSON array of directors
  companySecretary          String?
  
  // Share Capital
  shareCapital              Decimal?  @db.Decimal(15, 2)
  numberOfShares            Int?
  
  // Accounting Software & Methods
  accountingSoftware        String?   // Xero, QuickBooks, etc.
  accountingMethod          String?   // Cash basis, Accrual basis
  
  // Contact Information
  contactEmail              String?
  contactPhone              String?
  website                   String?
  
  // Additional Notes
  notes                     String?   @db.Text
  
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
}


// Audit Log for Deleted Transactions
model DeletedTransaction {
  id              String   @id @default(cuid())
  
  // Original Data Snapshot
  originalId      String?  // The ID it had in BankTransaction
  amount          Decimal  @db.Decimal(15, 2)
  currency        String
  description     String
  date            DateTime
  
  // Context
  bankAccountName String?
  bankName        String?
  
  // Audit Info
  deletedAt       DateTime @default(now())
  deletedBy       String?  // User ID or Email
  reason          String?
  
  // Raw Data (Backup)
  fullSnapshot    String?  @db.Text // JSON string of the complete original object
}
